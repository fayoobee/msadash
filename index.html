// Toggle collapsible sections
document.addEventListener("DOMContentLoaded", () => {
  const collapsibles = document.querySelectorAll(".collapsible");
  collapsibles.forEach(button => {
    button.addEventListener("click", () => {
      button.classList.toggle("active");
      const content = button.nextElementSibling;
      content.style.display = content.style.display === "block" ? "none" : "block";
    });
  });

  // Toggle night mode
  const toggleModeBtn = document.getElementById("toggle-mode");
  toggleModeBtn.addEventListener("click", () => {
    document.body.classList.toggle("night-mode");
  });

  // Fetch data
  fetchTasks();
  fetchCountdowns();
  fetchTeamRoles();
});

const fetchTasks = async () => {
  const container = document.getElementById("task-container");
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGgYOn6rf3TCHQ0IWTBuGtjxLGNrSIgcXoxnOGT8bKN6c4BRmULTI-A7alSK1XtJVMFsFS3MEuKcs9/pub?gid=31970795&single=true&output=csv";
  const response = await fetch(sheetUrl);
  const data = await response.text();
  const rows = data.split("\n").slice(1);

  const tasksByCycle = {};

  rows.forEach(row => {
    const [task, assignedTo, due, progress, department, details, category, type, cycle, priority] = row.split(",");
    if (!tasksByCycle[cycle]) tasksByCycle[cycle] = [];

    tasksByCycle[cycle].push({
      task,
      assignedTo,
      due,
      progress,
      department,
      details,
      category,
      type,
      cycle,
      priority
    });
  });

  container.innerHTML = "";

  Object.keys(tasksByCycle).forEach(cycle => {
    const section = document.createElement("div");
    section.innerHTML = `<h3>${cycle}</h3>`;

    tasksByCycle[cycle].forEach(task => {
      const priorityClass =
        task.priority.toLowerCase() === "high"
          ? "priority-high"
          : task.priority.toLowerCase() === "medium"
          ? "priority-medium"
          : "priority-low";

      section.innerHTML += `
        <div class="task-card">
          <strong>${task.task}</strong><br>
          <em>Category:</em> ${task.category}<br>
          Assigned to: ${task.assignedTo}<br>
          Due: ${task.due}<br>
          Progress: ${task.progress}<br>
          Cycle: ${task.cycle}<br>
          <em>Details:</em> ${task.details}<br>
          <div class="priority-badge ${priorityClass}">Priority: ${task.priority}</div>
        </div>
      `;
    });

    container.appendChild(section);
  });
};

const fetchCountdowns = async () => {
  const container = document.getElementById("countdowns");
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGgYOn6rf3TCHQ0IWTBuGtjxLGNrSIgcXoxnOGT8bKN6c4BRmULTI-A7alSK1XtJVMFsFS3MEuKcs9/pub?gid=234415343&single=true&output=csv";
  const response = await fetch(sheetUrl);
  const data = await response.text();
  const rows = data.split("\n").slice(1);

  container.innerHTML = "";
  rows.forEach(row => {
    const [label, dateStr] = row.split(",");
    const targetDate = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((targetDate - now) / (1000 * 60 * 60 * 24));

    const countdownText = diff >= 0 ? `${diff} days left` : `Occurred ${-diff} days ago`;

    container.innerHTML += `<p><strong>${label}:</strong> ${countdownText}</p>`;
  });
};

const fetchTeamRoles = async () => {
  const container = document.getElementById("team-roles");
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGgYOn6rf3TCHQ0IWTBuGtjxLGNrSIgcXoxnOGT8bKN6c4BRmULTI-A7alSK1XtJVMFsFS3MEuKcs9/pub?gid=553348135&single=true&output=csv";
  const response = await fetch(sheetUrl);
  const data = await response.text();
  const rows = data.split("\n").slice(1);

  container.innerHTML = "<ul>";
  rows.forEach(row => {
    const [name, role] = row.split(",");
    container.innerHTML += `<li><strong>${name}:</strong> ${role}</li>`;
  });
  container.innerHTML += "</ul>";
};
